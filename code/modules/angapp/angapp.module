<?php

/**
 * Implements hook_mail().
 */
function angapp_mail($key, &$message, $params) {

  switch ($key) {

    case 'results':

      // Prepare subject and body.
      $message['from'] = \Drupal::config('system.site')->get('mail');
      $message['subject'] = 'Your Uni Arrival Advisor Steps';

      $step = 1;
      $previous_header = "";

      foreach ($params['intro'] as $row) {
        $message['body'][] = $row['title'];
        $message['body'][] = $row['body'];
      }

      $message['body'][] = '<h3 style="color:black;text-transform:uppercase;">Your selections:</h3><ul style="border-bottom:1px dashed black;color:black;padding-bottom:15px;padding-left:0;">';

      foreach ($params['progress'] as $row) {
        $message['body'][] = '<li style="margin-bottom:.5em;"><b style:"text-transform:uppercase;">' . $row['question'] . ':</b><br> ' . $row['answer'] . '</li>';
      }

      $message['body'][] = '</ul><p style="color:black !important;">';

      foreach ($params['nodes'] as $row) {
        if (in_array($row['nid'], $params['hidden'])) {
          continue;
        }
        if ($previous_header != $row['header']) {
          $message['body'][] = '<h1 style="color:black;text-transform:uppercase;">Step ' . $step++ . ':</h1>';
          $previous_header = $row['header'];
        }
        $message['body'][] = '<p style="color:black;">' . $row['answer'] . '</p>';
      }

      $message['body'][] = '<p style="border-top: 1px dashed black;">';

      foreach ($params['disclaimer'] as $row) {
        $message['body'][] = '<h3 style="color:gray;text-transform:uppercase;">' . $row['title'] . '</h3>';
        $message['body'][] = '<p style="color:gray;font-size.9em;"' . $row['body'] . '</p>';
      }

      $message['body'][] = '</p>';

      break;
  }
}
